name: Initial Pipeline

# Triggers: Runs on push to 'main' branch or when manually triggered
on:
  push:
    branches:
      - main
  workflow_dispatch: # Allows manual running from the GitHub UI

# Global environment variables
env:
  PYTHON_VERSION: '3.10'

jobs:
  # 1. Job: Security Check and Code Formatting
  security_and_format:
    name: Security Scan & Format Code Check
    runs-on: ubuntu-latest

    steps:
      - name: 1. Checkout Code
        uses: actions/checkout@v4
        with:
          # REQUIRED: Set depth to 0 to ensure the full history is available
          fetch-depth: 0

      - name: 2. Secrets Detection (Gitleaks)
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: 3. Set up Python ${{ env.PYTHON_VERSION }} (for Black)
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: 4. Install Black
        run: pip install black

      - name: 5. Run Black (Check only)
        run: black --check .

  # 2. Job: Code Linting and Testing
  build_and_test:
    name: Linting & Testing Python App
    runs-on: ubuntu-latest
    # Requires the 'security_and_format' job to succeed first
    needs: [ security_and_format ]

    env:
      PYTHON_VERSION: '3.10'
      # ðŸ”‘ FIX 1 & 2: Use the repository secret names for the AI model and API key.
      # The code likely uses AI_MODEL internally, so we map the secret name to the variable name.
      AI_MODEL: ${{ secrets.GOOGLE_AI_MODEL }}
      GEMINI_API_KEY: ${{ secrets.GOOGLE_API_KEY }}

      # ðŸ”‘ FIX 3 & 4: Add NOTION secrets (assuming the code needs them for initialization).
      NOTION_API_KEY: ${{ secrets.NOTION_API_KEY }}
      NOTION_API_VERSION: ${{ secrets.NOTION_API_VERSION }}

    steps:
      - name: 1. Checkout Code
        uses: actions/checkout@v4

      - name: 2. Set up Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: 3. Install Dependencies (Linting & Testing)
        # Ensure all required development packages are installed
        run: |
          pip install -r requirements.txt
          pip install flake8 pytest

      - name: 4. Run Linting (flake8)
        run: flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics

      - name: 5. Run Pytest Tests
        env:
          GOOGLE_AI_MODEL: "gemini-2.5-flash"
        run: pytest

  # 3. Job: Deployment
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    # Only runs if the previous job ('build_and_test') succeeds
    needs: [ build_and_test ]

    # Optional: Use this if you need to protect the production environment
    # environment: production

    steps:
      - name: 1. Checkout Code
        uses: actions/checkout@v4

      - name: 2. Vercel Deployment Step (Placeholder)
        run: echo "Tests passed. Code is clean and ready for deployment."