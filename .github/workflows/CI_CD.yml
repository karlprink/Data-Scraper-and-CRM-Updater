name: Initial Pipeline

# Triggers: Runs on push to 'main' branch or when manually triggered
on:
  push:
    branches:
      - main
  workflow_dispatch: # Allows manual running from the GitHub UI

# Global environment variables
env:
  PYTHON_VERSION: '3.10'

jobs:
  # 1. Job: Security Check and Code Formatting
  security_and_format:
    name: Security Scan & Format Code Check
    runs-on: ubuntu-latest

    steps:
      - name: 1. Checkout Code
        uses: actions/checkout@v4

      - name: 2. Secrets Detection (Gitleaks)
        # Checks if any sensitive keys or secrets were accidentally committed
        uses: gitleaks/gitleaks-action@v0.12.0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: 3. Set up Python ${{ env.PYTHON_VERSION }} (for Black)
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: 4. Install Black
        run: pip install black

      - name: 5. Run Black (Check only)
        # Verifies that the code adheres to Black standards. Fails if formatting is needed.
        run: black --check .

  # 2. Job: Code Linting and Testing
  build_and_test:
    name: Linting & Testing Python App
    runs-on: ubuntu-latest
    # Requires the 'security_and_format' job to succeed first
    needs: [security_and_format]

    steps:
      - name: 1. Checkout Code
        uses: actions/checkout@v4

      - name: 2. Set up Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: 3. Install Dependencies (Linting & Testing)
        run: |
          pip install -r requirements.txt
          pip install flake8 pytest

      - name: 4. Run Linting (flake8)
        # Runs the linting checks defined in the original configuration
        run: flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics

      - name: 5. Run Pytest Tests
        # If tests fail, this job will terminate and the Deployment job will not run.
        run: pytest

  # 3. Job: Deployment
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    # Only runs if the previous job ('build_and_test') succeeds
    needs: [build_and_test]

    # Optional: Use this if you need to protect the production environment
    # environment: production

    steps:
      - name: 1. Checkout Code
        uses: actions/checkout@v4

      - name: 2. Vercel Deployment Step (Placeholder)
        # REPLACE THIS STEP with your specific Vercel or other deployment action.
        # Example using a common action:
        # uses: amondnet/vercel-action@v2
        # env:
        #   VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
        #   VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
        #   VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
        run: echo "Tests passed. Code is clean and ready for deployment."